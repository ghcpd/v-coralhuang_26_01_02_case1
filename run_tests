#!/usr/bin/env python3
"""
Test runner script for the agent_tools project.

This script:
1. Creates a virtual environment if it doesn't exist
2. Installs required dependencies
3. Runs the full test suite
"""

import subprocess
import sys
import os
from pathlib import Path

def main():
    # Get the project root (directory containing this script)
    project_root = Path(__file__).parent.absolute()
    venv_path = project_root / ".venv"
    
    # Determine Python executable path
    if sys.platform == "win32":
        python_exe = venv_path / "Scripts" / "python.exe"
        pip_exe = venv_path / "Scripts" / "pip.exe"
        pytest_exe = venv_path / "Scripts" / "pytest.exe"
    else:
        python_exe = venv_path / "bin" / "python"
        pip_exe = venv_path / "bin" / "pip"
        pytest_exe = venv_path / "bin" / "pytest"
    
    # Step 1: Create virtual environment if it doesn't exist
    if not venv_path.exists():
        print(f"Creating virtual environment at {venv_path}...")
        result = subprocess.run(
            [sys.executable, "-m", "venv", str(venv_path)],
            cwd=str(project_root)
        )
        if result.returncode != 0:
            print(f"Error: Failed to create virtual environment.", file=sys.stderr)
            sys.exit(1)
        print("✓ Virtual environment created")
    else:
        print("✓ Virtual environment already exists")
    
    # Step 2: Install dependencies
    print("Installing dependencies...")
    result = subprocess.run(
        [str(pip_exe), "install", "-q", "pytest", "pytest-asyncio"],
        cwd=str(project_root)
    )
    if result.returncode != 0:
        print(f"Error: Failed to install dependencies.", file=sys.stderr)
        sys.exit(1)
    print("✓ Dependencies installed")
    
    # Step 3: Run tests
    print("\nRunning tests...\n")
    result = subprocess.run(
        [str(pytest_exe), "-q"],
        cwd=str(project_root)
    )
    
    if result.returncode == 0:
        print("\n✓ All tests passed!")
    else:
        print("\n✗ Tests failed!", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
